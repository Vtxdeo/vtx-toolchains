name: Sync & Repack Toolchains

on:
  schedule:
    - cron: '0 0 1 * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  repack_and_release:
    name: Repack ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            docker_tag: x86_64-linux-musl
          - arch: aarch64
            docker_tag: aarch64-linux-musl
          - arch: arm-linux-musleabi
            docker_tag: arm-linux-musleabi
          - arch: mipsel
            docker_tag: mipsel-linux-musl
          - arch: riscv64
            docker_tag: riscv64-linux-musl

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Extract from Docker
        run: |
          IMAGE="muslcc/x86_64:${{ matrix.docker_tag }}"
          echo ">>> Pulling Docker image: $IMAGE"
          docker pull $IMAGE

          CONTAINER_ID=$(docker run -d --entrypoint /bin/sh $IMAGE -c "tail -f /dev/null")
          
          echo ">>> Container started: $CONTAINER_ID"

          COMPILER_BIN="${{ matrix.docker_tag }}-gcc"
          COMPILER_PATH=$(docker exec $CONTAINER_ID which $COMPILER_BIN)
          echo ">>> Found compiler at: $COMPILER_PATH"

          TOOLCHAIN_BIN_DIR=$(dirname "$COMPILER_PATH")
          TOOLCHAIN_ROOT=$(dirname "$TOOLCHAIN_BIN_DIR")
          echo ">>> Toolchain root determined as: $TOOLCHAIN_ROOT"

          docker cp "$CONTAINER_ID:$TOOLCHAIN_ROOT" ./extracted_toolchain

          docker rm -f $CONTAINER_ID

          cd extracted_toolchain
          tar -czf ../original.tgz .
          cd ..
          rm -rf extracted_toolchain

      - name: Run Repack Script
        id: repack
        run: |
          chmod +x scripts/repack.sh
          ./scripts/repack.sh "${{ matrix.arch }}" "docker://${{ matrix.docker_tag }}" "original.tgz"

      - name: Generate Checksum
        run: sha256sum ${{ steps.repack.outputs.FILE_PATH }} > ${{ steps.repack.outputs.FILE_PATH }}.sha256

      - name: Release Toolchain
        uses: softprops/action-gh-release@v1
        with:
          tag_name: toolchain-latest
          files: |
            ${{ steps.repack.outputs.FILE_PATH }}
            ${{ steps.repack.outputs.FILE_PATH }}.sha256
          body: "Automated VTX Toolchains synchronization from Docker Hub. Build Date: $(date +'%Y-%m-%d')"
          prerelease: false